<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Brain Segmentation Team" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>CHARM Segmentation - Brain Segmentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "CHARM Segmentation";
        var mkdocs_page_input_path = "training_data/charm.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Brain Segmentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../installation/">Installation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Contributing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../contribute/contributing/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../contribute/howto_write_docs/">Writing Documentation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../contribute/howto_write_code/">Writing Code</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">HPC Cluster</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../cluster/info/">General Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cluster/apptainer/">Apptainer Build</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Creating Training Data</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">General Approach</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">CHARM Segmentation</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#description-of-the-charm-method">Description of the CHARM Method</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#pipeline-steps">Pipeline Steps</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#environment-preparation">Environment Preparation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#prerequisites">Prerequisites</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#environment-installation">Environment Installation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#running-the-segmentation">Running the Segmentation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#inputs-of-segmentation">Inputs of Segmentation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#outputs-of-segmentation">Outputs of Segmentation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#viewing-results">Viewing Results</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface-of-fsleyes">Interface of FSLEyes</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../synth_seg/">SynthSeg Segmentation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../FullHeadSeg/">FullHeadSeg</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../upscaling/">Label Upscaling</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/">API Reference</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Brain Segmentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Creating Training Data</li>
      <li class="breadcrumb-item active">CHARM Segmentation</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/halirutan/BrainSegmentation/edit/main/docs/training_data/charm.md">Edit on BrainSegmentation</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="charm-segmentation">Charm Segmentation<a class="headerlink" href="#charm-segmentation" title="Permanent link">&para;</a></h1>
<p>This document provides a detailed overview of the CHARM (SimNIBS) segmentation installation, execution, and setup.</p>
<hr />
<h2 id="description-of-the-charm-method">Description of the CHARM Method<a class="headerlink" href="#description-of-the-charm-method" title="Permanent link">&para;</a></h2>
<p>The SimNIBS package is usually used to calculate electric fields caused by Transcranial Electrical Stimulation (TES) and
Transcranial Magnetic Stimulation (TMS).
For this project, we will only use the full head segmentation functionality of SimNIBS to get
labeled images for the regions outside the brain.
Later we will merge these outer parts with the brain segmentation from a different, high-quality algorithm.</p>
<h3 id="pipeline-steps">Pipeline Steps<a class="headerlink" href="#pipeline-steps" title="Permanent link">&para;</a></h3>
<p>The complete SimNIBS pipeline is divided into three parts:</p>
<ol>
<li>Automatic segmentation of MRI images and meshing to create individualized head models</li>
<li>Calculation of electric fields through the Finite Element Method (FEM)</li>
<li>Post-processing of results for further analysis.</li>
</ol>
<p>For this project, we will only use the first step.</p>
<hr />
<h2 id="environment-preparation">Environment Preparation<a class="headerlink" href="#environment-preparation" title="Permanent link">&para;</a></h2>
<h3 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h3>
<p>Ensure that the following software is present:</p>
<ul>
<li>Python 3.8 or newer</li>
<li>Installed miniforge</li>
</ul>
<h3 id="environment-installation">Environment Installation<a class="headerlink" href="#environment-installation" title="Permanent link">&para;</a></h3>
<p>The first step is to clone the latest release of the SimNIBS repository from GitHub.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When building an Apptainer, we recommend using the latest release of SimNIBS.
We had problems with version 4.5.0., which resulted in a compilation bug that could be traced back
to the wrong Boost library.</p>
</div>
<pre class="codehilite"><code class="language-shell">git clone --depth 1 https://github.com/simnibs/simnibs.git --branch v4.5.0
</code></pre>

<p>To install SimNIBS into a new environment, use the following steps:</p>
<pre class="codehilite"><code class="language-shell">cd simnibs
source conda_path/etc/profile.d/conda.sh
source conda_path/etc/profile.d/mamba.sh

mamba env create -f environment_linux.yml # we assume a Linux environment here!
conda activate simnibs_env
pip install -e .
python simnibs/cli/link_external_progs.py

# If you need fsleyes for viewing, uncomment the next line
# pip install fsleyes
</code></pre>

<h2 id="running-the-segmentation">Running the Segmentation<a class="headerlink" href="#running-the-segmentation" title="Permanent link">&para;</a></h2>
<p>After installing SimNIBS, you should verify that it works correctly.
To do this, use an example Nifti file with <code>.nii</code> extension and execute the following command:</p>
<pre class="codehilite"><code>charm &quot;file_id&quot; image/path/example.nii
</code></pre>

<p>where</p>
<ol>
<li><code>file_id</code> is a name chosen by the user for this segmentation (it is recommended to use the same name as the MRI file that needs to be segmented).</li>
<li><code>image/path/example.nii</code> is the path to the MRI file that needs to be segmented.</li>
</ol>
<h3 id="inputs-of-segmentation">Inputs of Segmentation<a class="headerlink" href="#inputs-of-segmentation" title="Permanent link">&para;</a></h3>
<p><code>example.nii</code> - a file with the MRI image that needs to be segmented.</p>
<h3 id="outputs-of-segmentation">Outputs of Segmentation<a class="headerlink" href="#outputs-of-segmentation" title="Permanent link">&para;</a></h3>
<ul>
<li><code>m2m_file_id</code> - A directory containing all the information about segmentation and electrode connections.</li>
<li><code>labeling.nii.gz</code> - A specific file required for further work, located in the <code>m2m_file_id</code> directory at the 
   path <code>image/path/m2m_file_id/segmentation/labeling.nii.gz</code></li>
</ul>
<h3 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h3>
<p>The following Python code demonstrates how to segment all MRI images in a specified directory:</p>
<pre class="codehilite"><code class="language-shell">import os
import time

#Enter into the variables the path to a directory with MRI files
path = &quot;/example/path/Try_A/Dir_Seg&quot;
path_res = path + &quot;/../Dir_Seg_Res&quot;
os.system(&quot;mkdir &quot; + path_res)
for file in os.listdir(path):
    time.sleep(1)
    name = os.path.basename(file).split('.')[0]
    com = &quot;touch &quot; + path + &quot;/Process.txt; charm &quot; + name + &quot; &quot; + os.path.abspath(file) + &quot;; mv &quot; + path + &quot;/m2m_&quot; + name + &quot; &quot; + path_res + &quot;; rm -f &quot; + path + &quot;/Process.txt&quot;
    os.system(com)
    time.sleep(1)
    while os.path.exists(path + &quot;/Process.txt&quot;):
        time.sleep(5)
</code></pre>

<p>To run the code:</p>
<ol>
<li>Enter the path to the directory containing the MRI files into the "path" variable in the code.</li>
<li>Run the "python" command in the SimNIBS environment in the Terminal.</li>
</ol>
<hr />
<h2 id="viewing-results">Viewing Results<a class="headerlink" href="#viewing-results" title="Permanent link">&para;</a></h2>
<p>After the segmentation is complete, you can view the results using the FSLEyes program. For the directory that contains the results of the MRI image segmentation, enter the following command:</p>
<p><code>fsleyes #PATH/m2m_"Name of File"/segmentation/labeling.nii.gz</code></p>
<p>This launches the FSLEyes program to view the segmentation results, where #PATH is the path to the directory with the results.</p>
<h3 id="interface-of-fsleyes">Interface of FSLEyes<a class="headerlink" href="#interface-of-fsleyes" title="Permanent link">&para;</a></h3>
<p>In the opened window, you can see the results and adjust the settings as needed. To clearly view the organs from the CHARM segmentation, use the following settings in the top of the window:</p>
<ul>
<li>
<p>In "Labeling", select "Label Image" to see each organ with its particular label.</p>
</li>
<li>
<p>Set "Outline width" to be thick enough so that the boundary lines are clearly visible without blocking any details.</p>
</li>
<li>
<p>In "Look-up Table", use Random (big) or FreeSurferColorLut to see all the head segmentation with all organs clearly and brightly.</p>
</li>
<li>
<p>The rest of the settings: "Brightness", "Contrast", "Zoom", "Opacity", can be adjusted according to your preference, but these values are recommended:</p>
</li>
<li>Brightness: Middle</li>
<li>Contrast: Middle</li>
<li>Zoom: 100</li>
<li>Opacity: Maximum (the right end)</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../overview/" class="btn btn-neutral float-left" title="General Approach"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../synth_seg/" class="btn btn-neutral float-right" title="SynthSeg Segmentation">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright &copy; 2023 Brain Segmentation Team</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/halirutan/BrainSegmentation" class="fa fa-code-fork" style="color: #fcfcfc"> BrainSegmentation</a>
        </span>
    
    
      <span><a href="../overview/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../synth_seg/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
