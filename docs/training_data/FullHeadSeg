FullHeadSeg: Automated Generation of Full Head Segmentation from MRI

This repository provides an automated pipeline to generate full-head segmentations by combining two state-of-the-art brain segmentation tools, CHARM and SynthSeg. This pipeline creates accurate and robust overlays of segmentations directly from T1-weighted MRI scans.

Prerequisites

Required Software:

SynthSeg: SynthSeg GitHub Repository

CHARM (SimNIBS): SimNIBS GitHub Repository

Conda environments: Ensure the following conda environments are set up:

SynthSeg environment

SimNIBS environment

Directory Structure:

Prepare your directories as follows:

input_dir/
├── subject1.nii.gz
├── subject2.nii.gz
└── ...

output_dir/ (generated by script)

Installation

Clone this repository:

git clone https://github.com/your_username/FullHeadSeg.git
cd FullHeadSeg

Make sure the required conda environments (synth_seg_orig_py38, simnibs_env) are properly configured with all dependencies installed.

Usage

Run the script from the command line:

python create_fh_seg.py <input_dir> <output_dir> <synthseg_script> <synthseg_dir>

Example:

python create_fh_seg.py \
    /data/pt_np-pscheibe/datasets/test_data/input \
    /data/pt_np-pscheibe/datasets/test_data/output \
    /data/pt_np-pscheibe/software/third_party/SynthSegOriginal/scripts/commands/SynthSeg_predict.py \
    /data/pt_np-pscheibe/software/third_party/SynthSegOriginal

Processing Pipeline

For each MRI scan, the pipeline performs:

CHARM segmentation:

Extracts labels related to head tissues.

SynthSeg segmentation:

Generates robust segmentation of brain tissues.

Resampling:

SynthSeg results are resampled to match CHARM segmentation space.

Overlay generation:

SynthSeg segmentation has priority over CHARM segmentation where overlaps occur.

Label consistency verification:

Ensures all generated segmentations contain a consistent set of labels across subjects.

Outputs

Overlay segmentation files: Saved in the output_dir with filenames ending in _overlay.nii.gz.

output_dir/
├── subject1_overlay.nii.gz
├── subject2_overlay.nii.gz
└── ...

Label Consistency Check

When multiple overlays are generated, the script automatically verifies label consistency to guarantee uniformity across the dataset.

Troubleshooting

Common Errors:

FileNotFoundError: Ensure all paths (input directory, SynthSeg script, SynthSeg directory) are correct.

Inconsistent labels: Indicates mismatched labels between overlays. Inspect input files for potential corruption or unexpected content.

